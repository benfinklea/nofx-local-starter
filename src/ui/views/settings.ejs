<!doctype html><html><head>
<meta charset="utf-8"/><title>NOFX - Settings</title>
<link rel="stylesheet" href="/ui/static/style.css"/>
</head><body>
<h1>Settings</h1>

<section>
  <h2>Approvals</h2>
  <label>DB Writes require approval:
    <select id="dbWrites">
      <option value="none">None</option>
      <option value="dangerous">Dangerous only (update/delete)</option>
      <option value="all">All writes</option>
    </select>
  </label>
  <label>
    <input type="checkbox" id="allowWaive"/> Allow Waive (dev only)
  </label>
</section>

<!-- Providers are managed on the Models page -->

<section>
  <h2>Checks (Gates)</h2>
  <label><input type="checkbox" id="gateTypecheck"/> Typecheck</label>
  <label><input type="checkbox" id="gateLint"/> Lint</label>
  <label><input type="checkbox" id="gateUnit"/> Unit</label>
  <label>Coverage Threshold: <input type="number" id="coverage" min="0" max="100" step="1"/> %</label>
</section>

<section>
  <h2>Data Writes (Allow-list)</h2>
  <p>Allowed operations by table. Add rows as needed.</p>
  <table id="rulesTable">
    <tr><th>Table</th><th>Insert</th><th>Update</th><th>Delete</th><th></th></tr>
  </table>
  <button onclick="addRuleRow()">Add Rule</button>
</section>

<section>
  <h2>AI Routing</h2>
  <p>Select model order for each task. Manage models on the <a href="/ui/models">Models</a> page.</n>
  <div>
    <h3>Docs</h3>
    <select id="docsSelect"></select>
    <button onclick="addToOrder('docs')">Add</button>
    <ul id="docsOrder"></ul>
  </div>
  <div>
    <h3>Reasoning</h3>
    <select id="reasoningSelect"></select>
    <button onclick="addToOrder('reasoning')">Add</button>
    <ul id="reasoningOrder"></ul>
  </div>
  <div>
    <h3>Codegen</h3>
    <select id="codegenSelect"></select>
    <button onclick="addToOrder('codegen')">Add</button>
    <ul id="codegenOrder"></ul>
  </div>
</section>

<p>
  <button onclick="save()">Save</button>
  <span id="status"></span>
  <a style="margin-left:12px" href="/ui/models">Manage Models</a>
</p>

<% /* Dev-only restart (visible always; backend checks NODE_ENV/role) */ %>
<section>
  <h2>Development</h2>
  <button onclick="restartBackend()" title="Writes a restart flag; dev server exits and restarts.">Restart Backend</button>
  <small style="color:#666">Requires DEV_RESTART_WATCH=1 in .env and admin login. No effect in production.</small>
  <span id="devStatus"></span>
  <p>Tip: This restarts both API and Worker processes started by npm run dev.</p>
</section>

<script>
async function load(){
  const rsp = await fetch('/settings');
  const { settings, db_write_rules } = await rsp.json();
  document.getElementById('dbWrites').value = settings.approvals.dbWrites;
  document.getElementById('allowWaive').checked = !!settings.approvals.allowWaive;
  document.getElementById('gateTypecheck').checked = !!settings.gates.typecheck;
  document.getElementById('gateLint').checked = !!settings.gates.lint;
  document.getElementById('gateUnit').checked = !!settings.gates.unit;
  document.getElementById('coverage').value = Math.round((settings.gates.coverageThreshold||0.9)*100);
  const table = document.getElementById('rulesTable');
  // clear existing rows except header
  while (table.rows.length > 1) table.deleteRow(1);
  for (const r of db_write_rules) {
    addRuleRow(r.table_name, r.allowed_ops||[]);
  }
  // Load models for dropdowns
  const modelsRsp = await fetch('/models');
  const modelsData = await modelsRsp.json();
  const models = (modelsData.models||[]).filter(m => m.active !== false).map(m=>m.name);
  for (const selId of ['docsSelect','reasoningSelect','codegenSelect']){
    const sel = document.getElementById(selId);
    sel.innerHTML = '';
    models.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt); });
  }
  state.docs = (settings.llm && settings.llm.modelOrder && settings.llm.modelOrder.docs) || [];
  state.reasoning = (settings.llm && settings.llm.modelOrder && settings.llm.modelOrder.reasoning) || [];
  state.codegen = (settings.llm && settings.llm.modelOrder && settings.llm.modelOrder.codegen) || [];
  renderOrder('docs'); renderOrder('reasoning'); renderOrder('codegen');

  // Providers
  const providers = (settings.llm && settings.llm.providers) || {};
  for (const name of Object.keys(providers)){
    const p = providers[name] || {};
    const pricing = (settings.llm && settings.llm.pricing && settings.llm.pricing[name]) || {};
    addProviderRow(name, p.kind, p.baseUrl||'', p.model||'', pricing.inputPer1M||'', pricing.outputPer1M||'');
  }
}

function addRuleRow(tableName='', ops=[]){
  const t = document.getElementById('rulesTable');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${escapeHtml(tableName)}" placeholder="schema.table"/></td>
    <td><input type="checkbox" ${ops.includes('insert')?'checked':''}></td>
    <td><input type="checkbox" ${ops.includes('update')?'checked':''}></td>
    <td><input type="checkbox" ${ops.includes('delete')?'checked':''}></td>
    <td><button onclick="this.closest('tr').remove()">Remove</button></td>
  `;
  t.appendChild(tr);
}

function collectRules(){
  const t = document.getElementById('rulesTable');
  const out = [];
  for (let i=1;i<t.rows.length;i++){
    const cells = t.rows[i].cells;
    const table = cells[0].querySelector('input').value.trim();
    if (!table) continue;
    const allowed_ops = [];
    if (cells[1].querySelector('input').checked) allowed_ops.push('insert');
    if (cells[2].querySelector('input').checked) allowed_ops.push('update');
    if (cells[3].querySelector('input').checked) allowed_ops.push('delete');
    out.push({ table_name: table, allowed_ops });
  }
  return out;
}

async function save(){
  const body = {
    settings: {
      approvals: {
        dbWrites: document.getElementById('dbWrites').value,
        allowWaive: document.getElementById('allowWaive').checked
      },
      gates: {
        typecheck: document.getElementById('gateTypecheck').checked,
        lint: document.getElementById('gateLint').checked,
        unit: document.getElementById('gateUnit').checked,
        coverageThreshold: Math.max(0, Math.min(1, (Number(document.getElementById('coverage').value)||90)/100))
      },
      llm: { modelOrder: { docs: state.docs, reasoning: state.reasoning, codegen: state.codegen } }
    },
    db_write_rules: collectRules()
  };
  const rsp = await fetch('/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const ok = rsp.ok;
  document.getElementById('status').textContent = ok ? 'Saved ✓' : 'Failed to save';
  if (ok) setTimeout(()=>document.getElementById('status').textContent='', 2000);
}

async function restartBackend(){
  const rsp = await fetch('/dev/restart', { method:'POST' });
  if (rsp.status === 401) { window.location.href = '/ui/login'; return; }
  document.getElementById('devStatus').textContent = rsp.ok ? 'Restarting…' : 'Failed';
}

function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function parseProviders(s){
  const list = String(s||'').split(',').map(x=>x.trim().toLowerCase()).filter(Boolean);
  const uniq = Array.from(new Set(list));
  // Always append known built-ins if absent to keep fallback available
  for (const p of ['openai','anthropic','gemini']) if (!uniq.includes(p)) uniq.push(p);
  return uniq;
}
function numOrUndef(id){
  const v = Number(document.getElementById(id).value);
  return isFinite(v) && v > 0 ? v : undefined;
}

function addProviderRow(name='', kind='openai', baseUrl='', model='', priceIn='', priceOut=''){
  const t = document.getElementById('providersTable');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="prov-name" value="${escapeHtml(name)}" placeholder="myllm"/></td>
    <td>
      <select class="prov-kind">
        ${['openai','anthropic','gemini','openai-compatible','http'].map(k=>`<option value="${k}" ${k===kind?'selected':''}>${k}</option>`).join('')}
      </select>
    </td>
    <td><input class="prov-base" value="${escapeHtml(baseUrl)}" placeholder="http://localhost:11434/v1/chat/completions"/></td>
    <td><input class="prov-model" value="${escapeHtml(model)}" placeholder="model-name"/></td>
    <td><input class="prov-price-in" type="number" step="0.01" min="0" value="${escapeHtml(priceIn)}"/></td>
    <td><input class="prov-price-out" type="number" step="0.01" min="0" value="${escapeHtml(priceOut)}"/></td>
    <td><button onclick="this.closest('tr').remove()">Remove</button></td>
  `;
  t.appendChild(tr);
}
function collectProviders(){
  const t = document.getElementById('providersTable');
  const out = {};
  for (let i=1;i<t.rows.length;i++){
    const row = t.rows[i];
    const name = row.querySelector('.prov-name').value.trim();
    if (!name) continue;
    out[name.toLowerCase()] = {
      kind: row.querySelector('.prov-kind').value,
      baseUrl: row.querySelector('.prov-base').value.trim() || undefined,
      model: row.querySelector('.prov-model').value.trim() || undefined,
    };
  }
  return out;
}
function collectProviderPricing(){
  const t = document.getElementById('providersTable');
  const out = {};
  for (let i=1;i<t.rows.length;i++){
    const row = t.rows[i];
    const name = row.querySelector('.prov-name').value.trim();
    if (!name) continue;
    const inP = Number(row.querySelector('.prov-price-in').value);
    const outP = Number(row.querySelector('.prov-price-out').value);
    if (isFinite(inP) || isFinite(outP)) {
      out[name.toLowerCase()] = { inputPer1M: isFinite(inP)?inP:undefined, outputPer1M: isFinite(outP)?outP:undefined };
    }
  }
  return out;
}

// Model-order UI state and helpers
const state = { docs: [], reasoning: [], codegen: [] };
function addToOrder(kind){
  const sel = document.getElementById(kind+'Select');
  const val = sel && sel.value;
  if (!val) return;
  state[kind].push(val);
  renderOrder(kind);
}
function renderOrder(kind){
  const ul = document.getElementById(kind+'Order');
  if (!ul) return;
  ul.innerHTML = '';
  state[kind].forEach((name, idx) => {
    const li = document.createElement('li');
    li.textContent = name + ' ';
    const up = document.createElement('button'); up.textContent = '↑'; up.onclick = ()=>{ if (idx>0){ const t=state[kind][idx-1]; state[kind][idx-1]=state[kind][idx]; state[kind][idx]=t; renderOrder(kind);} };
    const down = document.createElement('button'); down.textContent = '↓'; down.onclick = ()=>{ if (idx<state[kind].length-1){ const t=state[kind][idx+1]; state[kind][idx+1]=state[kind][idx]; state[kind][idx]=t; renderOrder(kind);} };
    const rm = document.createElement('button'); rm.textContent = '✕'; rm.onclick = ()=>{ state[kind].splice(idx,1); renderOrder(kind); };
    li.appendChild(up); li.appendChild(down); li.appendChild(rm);
    ul.appendChild(li);
  });
}

load();
</script>
</body></html>

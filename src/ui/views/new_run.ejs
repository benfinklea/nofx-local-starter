<!doctype html><html><head>
<meta charset="utf-8"/><title>NOFX - New Run</title>
<link rel="stylesheet" href="/ui/static/style.css"/>
</head><body>
<div class="header"><div class="inner">
  <div class="brand"><a href="/ui/runs">NOFX</a></div>
  <div class="nav">
    <a href="/ui/runs">Runs</a>
    <a href="/ui/models">Models</a>
    <a href="/ui/settings">Settings</a>
  </div>
</div></div>
<div class="container">
<div class="section-title"><h1 style="margin:12px 0">New Run</h1><span class="tip" data-tip="Tell NOFX what you want in plain language. Quality checks run automatically based on Settings. Developers can expand the JSON editor below.">?</span></div>

<section class="card"><div class="bd">
  <h2>Standard</h2>
  <label>What should it do?
    <textarea id="std_prompt" rows="5" placeholder="Example: Create a clear README that explains NOFXâ€™s control plane, verification gates, and workers. Open a PR with the change."></textarea>
  </label>
  <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
    <label style="display:inline-flex;gap:6px;align-items:center"><input id="std_quality" type="checkbox" checked/> Include quality checks</label>
    <label style="display:inline-flex;gap:6px;align-items:center"><input id="std_openpr" type="checkbox"/> Open a GitHub PR</label>
    <button class="btn primary" onclick="createStandardRun()">Create Run</button>
  </div>
  <small class="muted">Checks and approvals follow your Settings. You can adjust them any time.</small>
</div></section>

<section class="card" style="margin-top:16px"><div class="bd">
  <h2>Developers</h2>
  <label>Goal <input id="goal" placeholder="Describe the goal" style="max-width:420px"/></label>
  <div>
    <textarea id="plan" rows="18" style="width:100%;max-width:900px" placeholder='{
  "steps": [
    { "name": "typecheck", "tool": "gate:typecheck" },
    { "name": "lint", "tool": "gate:lint" },
    { "name": "unit", "tool": "gate:unit" },
    { "name": "write readme", "tool": "codegen", "inputs": { "topic": "Welcome", "bullets": ["Control plane","Verification","Workers"] } }
  ]
}'></textarea>
  </div>
  <p><button class="btn" onclick="createRun()">Create Run (Developers)</button> <span id="status" class="muted"></span></p>
</div></section>
</div>

<script>
function setPlan(obj){ document.getElementById('plan').value = JSON.stringify(obj, null, 2); }
function presetGatedCodegen(){
  setPlan({ steps:[
    { name:'typecheck', tool:'gate:typecheck' },
    { name:'lint', tool:'gate:lint' },
    { name:'unit', tool:'gate:unit' },
    { name:'write readme', tool:'codegen', inputs:{ topic:'Welcome', bullets:['Control plane','Verification','Workers'] } }
  ]});
  document.getElementById('goal').value = 'gated codegen';
}
function presetManualDeploy(){
  setPlan({ steps:[ { name:'deploy approval', tool:'manual:deploy' } ]});
  document.getElementById('goal').value = 'manual approval';
}
function presetCodegenPR(){
  setPlan({ steps:[
    { name:'write readme', tool:'codegen', inputs:{ topic:'Welcome', bullets:['Control plane','Verification','Workers'] } },
    { name:'open pr', tool:'git_pr', inputs: { branch: 'feat/nofx-readme', base: 'main', title: 'docs: add readme', commits:[ { path:'README.md', fromArtifact:'runs/REPLACE_RUN/steps/REPLACE_STEP/README.md' } ] } }
  ]});
  document.getElementById('goal').value = 'codegen + PR';
}
async function createRun(){
  const goal = document.getElementById('goal').value || 'ad-hoc run';
  let plan;
  try { plan = JSON.parse(document.getElementById('plan').value); } catch (e) { document.getElementById('status').textContent = 'Invalid JSON'; return; }
  const body = { plan: { goal, steps: plan.steps||[] } };
  const rsp = await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (!rsp.ok) { document.getElementById('status').textContent = 'Failed to create'; return; }
  const data = await rsp.json();
  // If preset with placeholders, try to patch artifact paths to real run/step
  try {
    const runId = data.id;
    const tl = await fetch(`/runs/${runId}`);
    const details = await tl.json();
    const codegenStep = (details.steps||[]).find(s => s.tool === 'codegen');
    const prStep = (details.steps||[]).find(s => s.tool === 'git_pr');
    if (codegenStep && prStep) {
      const updated = { plan: { goal, steps: [ { name: prStep.name, tool: 'git_pr', inputs: {
        branch: 'feat/nofx-readme', base: 'main', title: 'docs: add readme',
        commits: [ { path:'README.md', fromArtifact: `runs/${runId}/steps/${codegenStep.id}/README.md` } ]
      } } ] } };
      await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(updated) });
    }
  } catch {}
  window.location.href = `/ui/runs/${data.id}`;
}
async function createStandardRun(){
  const prompt = document.getElementById('std_prompt').value.trim();
  const quality = document.getElementById('std_quality').checked;
  const openPr = document.getElementById('std_openpr').checked;
  if (!prompt) { document.getElementById('status').textContent = 'Please describe what you want to do.'; return; }
  const body = { standard: { prompt, quality, openPr } };
  const rsp = await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (!rsp.ok) { document.getElementById('status').textContent = 'Failed to create'; return; }
  const data = await rsp.json();
  window.location.href = `/ui/runs/${data.id}`;
}
</script>
</body></html>

# Agent SDK Phase 2 - Implementation Status

**Date**: October 12, 2025
**Worktree**: `worktrees/sdk-phase2`
**Branch**: `feature/sdk-phase2`
**Agent**: api-documenter (installed âœ…)

## Executive Summary

Phase 2 is **ready to implement**. All planning and setup is complete. The worktree is created, tests are written, and we have a clear implementation path.

### Current Status: ðŸ“‹ PLANNING COMPLETE â†’ ðŸš€ READY TO IMPLEMENT

**What's Done**:
- âœ… Problem analysis and planning (Build with Claude workflow Phase 1)
- âœ… Agent selection (`api-documenter` chosen and installed)
- âœ… Worktree created (`worktrees/sdk-phase2`)
- âœ… Comprehensive integration tests already exist
- âœ… Mock adapter implementation provides clear structure
- âœ… `.bwc-usage.md` documents full implementation plan

**What's Next**:
- [ ] Fix npm cache permissions issue: `sudo chown -R 501:20 "/Users/benfinklea/.npm"`
- [ ] Install dependencies in worktree
- [ ] Implement real SDK integration (replace mock)
- [ ] Run tests
- [ ] Validate and merge

---

## Phase 1 Findings (Build with Claude Workflow Complete)

### 1.1 Problem Definition âœ…

**Objective**: Replace mock Agent SDK implementation with real `@anthropic-ai/claude-agent-sdk@0.1.0` integration

**Success Criteria**:
1. All integration tests pass (`tests/integration/agent-sdk.test.ts`)
2. Real SDK executes code generation successfully
3. Session memory persists across steps
4. Cost tracking matches SDK usage within 1%
5. Streaming events emit correctly
6. Zero new TypeScript errors
7. Backward compatibility maintained

**Constraints**:
- Time: 1-2 weeks estimated
- Must stay within API usage limits
- Feature flag must allow instant rollback
- All files must stay under 400 lines

**Rollback Plan**: Set `USE_AGENT_SDK=false` in environment

### 1.2 Agent Selection âœ…

**Selected**: `api-documenter`

**Rationale**:
- Specializes in SDK integration and API client generation
- Can help implement `@anthropic-ai/claude-agent-sdk` patterns correctly
- Will assist with OpenAPI documentation
- Provides best practices for authentication and error handling

### 1.3 Pre-Installation Status âœ…

**Phase 1 Foundation** (from previous session):
- âœ… `src/lib/agentSdk/adapter.ts` - 211 lines, mock implementation
- âœ… `src/worker/handlers/codegen_v2.ts` - SDK-powered handler
- âœ… `supabase/migrations/20250929000000_add_agent_sdk_support.sql` - DB schema
- âœ… `tests/integration/agent-sdk.test.ts` - 223 lines of comprehensive tests
- âœ… `@anthropic-ai/claude-agent-sdk@0.1.0` installed in package.json
- âœ… Documentation in `docs/Migrate to Agent SDK, Sept 29, 2025.md`
- âœ… Completion report in `docs/AGENT_SDK_PHASE1_COMPLETE.md`

**Current Worktree State**:
- Branch: `feature/sdk-phase2` (created from main)
- Status: Clean working tree
- Dependencies: Need to run `npm install` (permission issue to resolve first)

---

## Implementation Plan (Phase 2)

### Step 1: Environment Setup

**Fix npm cache permissions**:
```bash
# Run this command:
sudo chown -R 501:20 "/Users/benfinklea/.npm"

# Then install dependencies:
cd /Volumes/Development/nofx-local-starter/worktrees/sdk-phase2
npm install
```

**Verify SDK is available**:
```bash
npm list @anthropic-ai/claude-agent-sdk
# Should show: @anthropic-ai/claude-agent-sdk@0.1.0
```

**Check environment variables**:
```bash
# Ensure these are set:
echo $ANTHROPIC_API_KEY    # Must be present
echo $USE_AGENT_SDK         # Should be 'false' for testing, 'true' for production
```

### Step 2: Understand the Real SDK API

**Research the actual SDK interface**:
```typescript
// Need to determine the actual API from @anthropic-ai/claude-agent-sdk
// Expected structure (to be verified):
import { query, tool, type Options } from '@anthropic-ai/claude-agent-sdk';

// The SDK might look like:
const result = await query(prompt, {
  model: 'claude-sonnet-4-5',
  sessionId: 'unique-session-id',
  maxTokens: 4096,
  temperature: 0.7,
  tools: [...],
  hooks: {
    onToolCall: async (call) => {},
    onToolResult: async (result) => {},
  }
});
```

**Action**: Use `api-documenter` agent to help understand the SDK API patterns

### Step 3: Replace Mock Implementation

**File**: `src/lib/agentSdk/adapter.ts`

**Changes needed**:

1. **Import real SDK** (lines 1-6):
```typescript
// ADD:
import { query } from '@anthropic-ai/claude-agent-sdk';
// Or whatever the actual export is
```

2. **Replace `executeMock()` with real implementation** (lines 91-127):
```typescript
async executeWithSdk(
  step: Step,
  context: AgentSdkContext
): Promise<ExecutionResult> {
  const sessionId = context.runId;
  const prompt = this.buildPrompt(step);

  const options = {
    model: context.model || 'claude-sonnet-4-5',
    sessionId,
    maxTokens: context.maxTokens || 4096,
    temperature: context.temperature || 0.7,
    tools: this.buildTools(step),
    hooks: this.buildHooks(step, context),
  };

  log.info({
    runId: context.runId,
    stepId: step.id,
    model: options.model,
    sessionId,
  }, 'Executing step with Agent SDK');

  try {
    // REAL SDK CALL HERE
    const result = await query(prompt, options);

    // Extract response text
    const response = this.extractResponse(result);

    // Extract usage metrics
    const tokensUsed = result.usage?.total_tokens || 0;
    const cost = this.calculateCost(tokensUsed, options.model);

    return {
      response,
      metadata: {
        tokensUsed,
        cost,
        model: options.model,
        sessionId,
      },
    };
  } catch (error) {
    log.error({ error, runId: context.runId, stepId: step.id }, 'SDK execution failed');
    throw error;
  }
}
```

3. **Add helper methods**:
```typescript
/**
 * Extract text response from SDK result
 */
private extractResponse(result: any): string {
  // Implementation depends on actual SDK response structure
  // Might be result.content or result.text or result.message
  return result.content || result.text || String(result);
}
```

4. **Update hooks for real SDK** (lines 174-193):
```typescript
private buildHooks(step: Step, context: AgentSdkContext): any {
  return {
    onToolCall: async (toolCall: any) => {
      await recordEvent(
        context.runId,
        'sdk.tool_call',
        {
          tool: toolCall.name || toolCall.type,
          args: toolCall.args || toolCall.input
        },
        step.id
      );
    },
    onToolResult: async (result: any) => {
      await recordEvent(
        context.runId,
        'sdk.tool_result',
        {
          success: !result.error,
          output: result.output || result.result
        },
        step.id
      );
    },
    onStreamChunk: async (chunk: any) => {
      // NEW: Handle streaming if SDK supports it
      await recordEvent(
        context.runId,
        'sdk.stream',
        { type: chunk.type, content: chunk.content },
        step.id
      );
    },
  };
}
```

### Step 4: Handle Session Persistence

The mock implementation has in-memory session storage. We need to verify how the real SDK handles this:

**Options**:
1. **SDK handles it natively** - Just pass `sessionId`, SDK manages state
2. **We need to persist** - Store session data in database

**If SDK doesn't handle persistence**, add to adapter:
```typescript
private async loadSession(sessionId: string): Promise<any> {
  // Load from database
  const run = await query('SELECT sdk_session_data FROM run WHERE id = $1', [sessionId]);
  return run?.sdk_session_data || null;
}

private async saveSession(sessionId: string, sessionData: any): Promise<void> {
  // Save to database
  await query(
    'UPDATE run SET sdk_session_data = $1 WHERE id = $2',
    [sessionData, sessionId]
  );
}
```

### Step 5: Error Handling

Add comprehensive error handling:

```typescript
private async executeWithRetry(
  fn: () => Promise<any>,
  maxRetries = 3
): Promise<any> {
  let lastError;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error: any) {
      lastError = error;

      // Don't retry on auth errors or validation errors
      if (error.status === 401 || error.status === 403 || error.status === 400) {
        throw error;
      }

      // Retry on rate limits and server errors
      if (error.status === 429 || error.status >= 500) {
        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
        log.warn({ attempt, delay, error }, 'Retrying SDK call');
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }

      // Unknown error, don't retry
      throw error;
    }
  }

  throw lastError;
}
```

### Step 6: Update Tests

**File**: `tests/integration/agent-sdk.test.ts`

**Current tests** (already comprehensive):
- âœ… Basic SDK execution
- âœ… Session persistence across multiple calls
- âœ… Cost tracking accuracy
- âœ… Error handling with invalid model
- âœ… codegen:v2 handler artifact creation
- âœ… Feature flag integration
- âœ… Cost tracking validation

**Potential additions**:
```typescript
it('should handle streaming responses', async () => {
  // Test if SDK supports streaming
  let streamChunks = 0;

  const step: Step = {
    id: 'stream-test',
    run_id: 'test-stream',
    name: 'stream',
    tool: 'codegen:v2',
    inputs: { prompt: 'Count to 5' },
  };

  const result = await adapter.executeWithSdk(step, {
    runId: 'test-stream',
    model: 'claude-sonnet-4-5',
  });

  expect(result.response).toBeTruthy();
  // Check that events were recorded
}, 30000);

it('should handle API rate limits gracefully', async () => {
  // Test retry logic
  // This might be hard to test without actually hitting rate limits
}, 60000);

it('should validate ANTHROPIC_API_KEY is set', () => {
  expect(process.env.ANTHROPIC_API_KEY).toBeTruthy();
});
```

### Step 7: Validation & Testing

**Run the test suite**:
```bash
cd /Volumes/Development/nofx-local-starter/worktrees/sdk-phase2

# Run integration tests
npm test tests/integration/agent-sdk.test.ts

# Run all tests
npm test

# Check test coverage
npm run test:coverage

# Type check
npm run typecheck

# Lint
npm run lint

# Build
npm run build
```

**Expected results**:
- All tests pass
- Coverage >90% for `AgentSdkAdapter`
- Zero TypeScript errors
- No linting errors
- Build succeeds

### Step 8: Manual Testing

**Test with real API**:
```bash
# Set environment variable
export USE_AGENT_SDK=true
export ANTHROPIC_API_KEY=sk-ant-...

# Start services
npm run dev

# Create a test run
curl -X POST http://localhost:3000/runs \
  -H "Content-Type: application/json" \
  -d '{
    "plan": {
      "goal": "Test Agent SDK Phase 2",
      "steps": [{
        "name": "test-sdk",
        "tool": "codegen:v2",
        "inputs": {
          "topic": "Agent SDK Integration",
          "bullets": ["Real API calls", "Session persistence", "Cost tracking"],
          "filename": "test.md"
        }
      }]
    }
  }'

# Check the run status
curl http://localhost:3000/runs/{RUN_ID}

# View the generated artifact
curl http://localhost:3000/runs/{RUN_ID}/artifacts
```

**Verify**:
- [ ] Run completes successfully
- [ ] Artifact is generated with real content (not mock)
- [ ] Cost tracking shows real usage
- [ ] Session ID is stored in database
- [ ] Events are recorded correctly

### Step 9: Documentation Updates

**Update files**:

1. **Create Phase 2 completion doc**:
   ```bash
   docs/AGENT_SDK_PHASE2_COMPLETE.md
   ```

2. **Update AI_CODER_GUIDE.md**:
   - Add SDK integration troubleshooting
   - Document real SDK usage patterns

3. **Update TROUBLESHOOTING.md**:
   - Add common SDK error scenarios
   - Document retry behavior
   - Add rate limit handling

4. **Update API_REFERENCE.md**:
   - Document codegen:v2 handler
   - Add SDK configuration options
   - Include usage examples

### Step 10: Merge & Deploy

**Pre-merge checklist**:
- [ ] All tests pass
- [ ] Documentation updated
- [ ] No files exceed 400 lines
- [ ] Feature flag tested (ON and OFF)
- [ ] Rollback procedure documented
- [ ] Code reviewed

**Merge process**:
```bash
cd /Volumes/Development/nofx-local-starter
git checkout main
git merge feature/sdk-phase2
git push origin main

# Clean up worktree
git worktree remove worktrees/sdk-phase2
git branch -d feature/sdk-phase2
```

**Deployment**:
```bash
# Deploy to staging first
vercel --prod

# Monitor for 24-48 hours
# Check logs, metrics, costs

# If successful, mark Phase 2 complete
```

---

## Blocker Resolution

### Current Blocker: npm Permission Issue

**Error**: `EACCES: permission denied` when running `npm install`

**Root cause**: npm cache contains root-owned files from previous npm versions

**Solution**:
```bash
sudo chown -R 501:20 "/Users/benfinklea/.npm"
```

**After fixing**:
```bash
cd /Volumes/Development/nofx-local-starter/worktrees/sdk-phase2
npm install
npm test tests/integration/agent-sdk.test.ts
```

---

## Key Files & Line Counts

| File | Lines | Status | Notes |
|------|-------|--------|-------|
| `src/lib/agentSdk/adapter.ts` | 211 | ðŸ”„ Needs update | Replace mock with real SDK |
| `tests/integration/agent-sdk.test.ts` | 223 | âœ… Ready | Comprehensive tests exist |
| `src/worker/handlers/codegen_v2.ts` | ~130 | âœ… Ready | Already uses adapter |
| `.bwc-usage.md` | ~280 | âœ… Complete | Full planning doc |
| `.bwc-phase2-status.md` | (this file) | âœ… Complete | Implementation guide |

**Total new code**: ~150-200 lines (replacing mock implementation)

**File size compliance**: All files will stay under 400 lines âœ…

---

## Risk Assessment & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| SDK API different than expected | MEDIUM | MEDIUM | Use api-documenter agent, read SDK docs carefully |
| Breaking existing functionality | LOW | HIGH | Feature flag allows instant rollback |
| Unexpected API costs | LOW | MEDIUM | Cost alerts, daily limits in .env |
| Session persistence fails | LOW | MEDIUM | Fallback to stateless mode |
| Rate limiting issues | MEDIUM | LOW | Retry logic with exponential backoff |
| TypeScript errors | LOW | LOW | Strict type checking during development |

---

## Next Actions

**Immediate (User)**:
1. Fix npm cache permissions: `sudo chown -R 501:20 "/Users/benfinklea/.npm"`
2. Decide: Should we proceed with implementation or need more planning?

**If proceeding (AI Assistant with api-documenter agent)**:
1. Install dependencies in worktree
2. Research actual `@anthropic-ai/claude-agent-sdk` API
3. Implement real SDK integration
4. Run tests and validate
5. Create Phase 2 completion documentation

**Timeline**: 1-2 days for implementation, 1 day for testing, 1 day for documentation

---

## Success Metrics

**Phase 2 Complete When**:
- [x] Planning complete (this document)
- [ ] npm dependencies installed
- [ ] Real SDK integration implemented
- [ ] All integration tests pass
- [ ] Cost tracking verified accurate
- [ ] Session persistence works
- [ ] Feature flag tested (ON/OFF)
- [ ] Documentation updated
- [ ] Code merged to main
- [ ] Deployed to staging
- [ ] Monitored for 24 hours

**Production Ready When**:
- [ ] 100+ successful runs with SDK
- [ ] Cost per run within budget
- [ ] Error rate < 1%
- [ ] Session persistence > 99%
- [ ] Rollback plan tested
- [ ] Team trained

---

**Last Updated**: October 12, 2025, 3:05 PM
**Status**: ðŸ“‹ PLANNING COMPLETE â†’ ðŸš€ READY TO IMPLEMENT
**Next Step**: Fix npm permissions, then implement real SDK integration
